
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mypythontools_cicd.tests.tests_internal &#8212; Python 20-07-2022 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="https://malachov.github.io/mypythontools/tools/sphinx-alabaster-css/custom.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for mypythontools_cicd.tests.tests_internal</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module with functions for &#39;tests&#39; subpackage.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">import</span> <span class="nn">mylogging</span>
<span class="kn">from</span> <span class="nn">mypythontools.paths</span> <span class="kn">import</span> <span class="n">validate_path</span><span class="p">,</span> <span class="n">PathLike</span><span class="p">,</span> <span class="n">WslPath</span>
<span class="kn">from</span> <span class="nn">mypythontools.misc</span> <span class="kn">import</span> <span class="n">delete_files</span><span class="p">,</span> <span class="n">print_progress</span>
<span class="kn">from</span> <span class="nn">mypythontools.config</span> <span class="kn">import</span> <span class="n">Config</span><span class="p">,</span> <span class="n">MyProperty</span>
<span class="kn">from</span> <span class="nn">mypythontools.system</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_console_str_with_quotes</span><span class="p">,</span>
    <span class="n">terminal_do_command</span><span class="p">,</span>
    <span class="n">check_library_is_available</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">..venvs</span> <span class="kn">import</span> <span class="n">Venv</span><span class="p">,</span> <span class="n">prepare_venvs</span>
<span class="kn">from</span> <span class="nn">..project_paths</span> <span class="kn">import</span> <span class="n">PROJECT_PATHS</span>

<span class="n">INTERNAL_TESTS_PATH</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;This is only for internal use.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="TestConfig"><a class="viewcode-back" href="../../../mypythontools_cicd.tests.html#mypythontools_cicd.tests.TestConfig">[docs]</a><span class="k">class</span> <span class="nc">TestConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allow to setup tests.&quot;&quot;&quot;</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">tested_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">PathLike</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define path of tested folder.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | PathLike</span>

<span class="sd">        Default:</span>
<span class="sd">            None</span>

<span class="sd">        If None, root is used. Root is necessary if using doctest, &#39;tests&#39; folder not works for doctest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">run_tests</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define whether run tests or not.</span>

<span class="sd">        Type:</span>
<span class="sd">            bool</span>

<span class="sd">        Default:</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">tests_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">PathLike</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;If None, tests is used. It means where venv will be stored etc.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | PathLike</span>

<span class="sd">        Default:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prepare_test_venvs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create venvs with defined versions.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | list[str]</span>

<span class="sd">        Default:</span>
<span class="sd">            [&quot;3.7&quot;, &quot;3.10&quot;, &quot;wsl-3.7&quot;, &quot;wsl-3.10&quot;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;3.7&quot;</span><span class="p">,</span> <span class="s2">&quot;3.10&quot;</span><span class="p">,</span> <span class="s2">&quot;wsl-3.7&quot;</span><span class="p">,</span> <span class="s2">&quot;wsl-3.10&quot;</span><span class="p">]</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prepare_test_venvs_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PathLike</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Prepare venvs in defined path.</span>

<span class="sd">        Type:</span>
<span class="sd">            str</span>

<span class="sd">        Default:</span>
<span class="sd">            &quot;tests/venv&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;tests/venv&quot;</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">test_coverage</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether run test coverage plugin. If True, pytest-cov must be installed.</span>

<span class="sd">        Type:</span>
<span class="sd">            bool</span>

<span class="sd">        Default:</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">stop_on_first_error</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether stop on first error.</span>

<span class="sd">        Type:</span>
<span class="sd">            bool</span>

<span class="sd">        Default:</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">virtualenvs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PathLike</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Virtualenvs used to testing. It&#39;s used to be able to test more python versions at once.</span>

<span class="sd">        Example:</span>
<span class="sd">            ``[&quot;tests/venvs/3.7&quot;, &quot;tests/venvs/3.10&quot;]``. If you want to use current venv, use `[sys.prefix]`.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | Sequence[PathLike]</span>

<span class="sd">        Default:</span>
<span class="sd">            [&quot;tests/venv/3.7&quot;, &quot;tests/venv/3.10&quot;]</span>

<span class="sd">        If no `virtualenvs` nor `wsl_virtualenvs` is configured, then python that called the function</span>
<span class="sd">        will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;tests/venv/3.7&quot;</span><span class="p">,</span> <span class="s2">&quot;tests/venv/3.10&quot;</span><span class="p">]</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">wsl_virtualenvs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PathLike</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Define which wsl virtual environments will be tested via wsl.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | Sequence[PathLike]</span>

<span class="sd">        Default:</span>
<span class="sd">            [&quot;tests/venv/wsl-3.7&quot;, &quot;tests/venv/wsl-3.10&quot;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;tests/venv/wsl-3.7&quot;</span><span class="p">,</span> <span class="s2">&quot;tests/venv/wsl-3.10&quot;</span><span class="p">]</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sync_test_requirements</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;infer&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PathLike</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Define whether update libraries versions.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | Literal[&quot;infer&quot;] | PathLike | Sequence[PathLike]</span>

<span class="sd">        Default:</span>
<span class="sd">            [&quot;requirements.txt&quot;]</span>

<span class="sd">        If using `virtualenvs` define what libraries will be installed by path to requirements. It can</span>
<span class="sd">        also be a list of more files e.g ``[&quot;requirements.txt&quot;, &quot;requirements_dev.txt&quot;]``. If &quot;infer&quot;,</span>
<span class="sd">        auto detected (all requirements), not recursively, only on defined path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;requirements.txt&quot;</span><span class="p">]</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sync_test_requirements_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PathLike</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define the root if using just names or relative path, and not found.</span>

<span class="sd">        Type:</span>
<span class="sd">            PathLike</span>

<span class="sd">        Default:</span>
<span class="sd">            PROJECT_PATHS.root</span>

<span class="sd">        It&#39;s also necessary when using another referenced files. If inferring files, it&#39;s used to search.</span>
<span class="sd">        Defaults to PROJECT_PATHS.root.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PROJECT_PATHS</span><span class="o">.</span><span class="n">root</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">verbosity</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Define whether print details on errors or keep silent.</span>

<span class="sd">        Type:</span>
<span class="sd">            Literal[0, 1, 2]</span>

<span class="sd">        Default:</span>
<span class="sd">            1</span>

<span class="sd">        If 0, no details, parameters `-q and `--tb=line` are added. if 1, some details are added --tb=short.</span>
<span class="sd">        If 2, more details are printed (default --tb=auto).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extra_args</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;List of args passed to pytest.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | list</span>

<span class="sd">        Default:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<span class="n">default_test_config</span> <span class="o">=</span> <span class="n">TestConfig</span><span class="p">()</span>


<div class="viewcode-block" id="run_tests"><a class="viewcode-back" href="../../../mypythontools_cicd.tests.html#mypythontools_cicd.tests.run_tests">[docs]</a><span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">TestConfig</span> <span class="o">=</span> <span class="n">default_test_config</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Run tests. If any test fails, raise an error.</span>

<span class="sd">    This is not supposed for normal testing during development. It&#39;s usually part of pipeline an runs just</span>
<span class="sd">    before pushing code. It usually runs on more python versions and it&#39;s syncing dependencies, so takes much</span>
<span class="sd">    more time than testing in IDE.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (PipelineConfig, optional): TestConfig configuration object. Just import default_test_config</span>
<span class="sd">            and use intellisense and help tooltip with description. Defaults to `default_test_config`.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If any test fail, it will raise exception (git hook do not continue...).</span>

<span class="sd">    Note:</span>
<span class="sd">        By default args to quiet mode and no traceback are passed. Usually this just runs automatic tests.</span>
<span class="sd">        If some of them fail, it&#39;s further analyzed in some other tool in IDE.</span>

<span class="sd">    Example:</span>
<span class="sd">        ``run_tests(verbosity=2)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">run_tests</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">print_progress</span><span class="p">(</span><span class="s2">&quot;Testing&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">tested_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">validate_path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tested_path</span><span class="p">,</span> <span class="s2">&quot;Running tests failed&quot;</span><span class="p">,</span> <span class="s2">&quot;tested_path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">tested_path</span>
        <span class="k">else</span> <span class="n">PROJECT_PATHS</span><span class="o">.</span><span class="n">root</span>
    <span class="p">)</span>
    <span class="n">tests_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">validate_path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">tests_path</span><span class="p">,</span> <span class="s2">&quot;Running tests failed&quot;</span><span class="p">,</span> <span class="s2">&quot;tests_path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">tests_path</span>
        <span class="k">else</span> <span class="n">PROJECT_PATHS</span><span class="o">.</span><span class="n">tests</span>
    <span class="p">)</span>

    <span class="n">verbosity</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">verbosity</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="n">inner_verbosity</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">extra_args</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">extra_args</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">extra_args</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">stop_on_first_error</span><span class="p">:</span>
        <span class="n">extra_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-x&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">extra_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">)</span>
        <span class="n">extra_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--tb=line&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">extra_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--tb=short&quot;</span><span class="p">)</span>

    <span class="n">all_venvs</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">config</span><span class="o">.</span><span class="n">virtualenvs</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;wsl-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">wsl_virtualenvs</span><span class="p">]]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_venvs</span><span class="p">:</span>
        <span class="n">all_venvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">prepare_test_venvs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbosity</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Preparing test venvs&quot;</span><span class="p">)</span>
        <span class="n">prepare_venvs</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">prepare_test_venvs_path</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">prepare_test_venvs</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">venv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_venvs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">venv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;wsl-&quot;</span><span class="p">):</span>
            <span class="n">wsl</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">venv</span> <span class="o">=</span> <span class="n">venv</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wsl</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">used_path</span> <span class="o">=</span> <span class="n">tested_path</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">wsl</span> <span class="k">else</span> <span class="n">WslPath</span><span class="p">(</span><span class="n">tested_path</span><span class="p">)</span><span class="o">.</span><span class="n">wsl_path</span>
        <span class="n">tested_path_str</span> <span class="o">=</span> <span class="n">get_console_str_with_quotes</span><span class="p">(</span><span class="n">used_path</span><span class="p">)</span>

        <span class="n">complete_args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;pytest&quot;</span><span class="p">,</span>
            <span class="n">tested_path_str</span><span class="p">,</span>
            <span class="o">*</span><span class="n">extra_args</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">test_command</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">complete_args</span><span class="p">)</span>

        <span class="n">used_command</span> <span class="o">=</span> <span class="n">test_command</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">test_coverage</span><span class="p">:</span>
                <span class="c1"># Add coverage only to first virtualenv</span>
                <span class="n">xml_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;xml:</span><span class="si">{</span><span class="n">tests_path</span> <span class="o">/</span> <span class="s1">&#39;coverage.xml&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">used_command</span> <span class="o">=</span> <span class="n">used_command</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; --cov </span><span class="si">{</span><span class="n">get_console_str_with_quotes</span><span class="p">(</span><span class="n">PROJECT_PATHS</span><span class="o">.</span><span class="n">app</span><span class="p">)</span><span class="si">}</span><span class="s2"> --cov-report &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_console_str_with_quotes</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">my_venv</span> <span class="o">=</span> <span class="n">Venv</span><span class="p">(</span><span class="n">venv</span><span class="p">,</span> <span class="n">with_wsl</span><span class="o">=</span><span class="n">wsl</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">my_venv</span><span class="o">.</span><span class="n">installed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Defined virtualenv on </span><span class="si">{</span><span class="n">my_venv</span><span class="o">.</span><span class="n">venv_path</span><span class="si">}</span><span class="s2"> not found. Use &#39;prepare_test_venvs&#39; or install &quot;</span>
                <span class="s2">&quot;venvs manually.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sync_test_requirements</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbosity</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Syncing requirements in</span><span class="si">{</span><span class="s1">&#39; wsl &#39;</span> <span class="k">if</span> <span class="n">wsl</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">venv &#39;</span><span class="si">{</span><span class="n">my_venv</span><span class="o">.</span><span class="n">venv_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                    <span class="s2">&quot;for tests&quot;</span>
                <span class="p">)</span>
            <span class="n">my_venv</span><span class="o">.</span><span class="n">sync_requirements</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">sync_test_requirements</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;mypythontools_cicd[tests]&quot;</span><span class="p">],</span>
                <span class="n">verbosity</span><span class="o">=</span><span class="n">inner_verbosity</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sync_test_requirements_path</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># To be able to not install dev requirements in older python venv, pytest is installed.</span>
        <span class="c1"># Usually just respond with Requirements already satisfied.</span>
        <span class="k">if</span> <span class="n">INTERNAL_TESTS_PATH</span><span class="p">:</span>
            <span class="n">my_venv</span><span class="o">.</span><span class="n">install_library</span><span class="p">(</span><span class="s2">&quot;.[tests]&quot;</span><span class="p">,</span> <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">INTERNAL_TESTS_PATH</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">my_venv</span><span class="o">.</span><span class="n">install_library</span><span class="p">(</span><span class="s2">&quot;mypythontools_cicd[tests]&quot;</span><span class="p">,</span> <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">used_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">my_venv</span><span class="o">.</span><span class="n">activate_command</span><span class="si">}</span><span class="s2"> &amp;&amp; </span><span class="si">{</span><span class="n">test_command</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">verbosity</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Starting tests with </span><span class="si">{</span><span class="s1">&#39;wsl&#39;</span> <span class="k">if</span> <span class="n">wsl</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> venv `</span><span class="si">{</span><span class="n">venv</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>

        <span class="n">terminal_do_command</span><span class="p">(</span>
            <span class="n">used_command</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">tested_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">error_header</span><span class="o">=</span><span class="s2">&quot;Tests failed.&quot;</span><span class="p">,</span>
            <span class="n">with_wsl</span><span class="o">=</span><span class="n">wsl</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">test_coverage</span><span class="p">:</span>
        <span class="n">delete_files</span><span class="p">(</span><span class="s2">&quot;.coverage&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="setup_tests"><a class="viewcode-back" href="../../../mypythontools_cicd.tests.html#mypythontools_cicd.tests.setup_tests">[docs]</a><span class="k">def</span> <span class="nf">setup_tests</span><span class="p">(</span>
    <span class="n">generate_readme_tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">matplotlib_test_backend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">set_numpy_random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Add paths to be able to import local version of library as well as other test files.</span>

<span class="sd">    Value Mylogging.config.colorize = 0 changed globally.</span>

<span class="sd">    Note:</span>
<span class="sd">        Function expect `tests` folder on root. If not, test folder will not be added to sys path and</span>
<span class="sd">        imports from tests will not work.</span>

<span class="sd">    Args:</span>
<span class="sd">        generate_readme_tests (bool, optional): If True, generate new tests from readme if there are</span>
<span class="sd">            new changes. Defaults to True.</span>
<span class="sd">        matplotlib_test_backend (bool, optional): If using matlplotlib, it need to be</span>
<span class="sd">            closed to continue tests. Change backend to agg. Defaults to False.</span>
<span class="sd">        set_numpy_random_seed (int | None): If using numpy random numbers, it will be each time the same.</span>
<span class="sd">            Numpy is not in requirements, so it need to be installed. It&#39;s skipped if not available.</span>
<span class="sd">            Defaults to 2.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mylogging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colorize</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">PROJECT_PATHS</span><span class="o">.</span><span class="n">add_root_to_sys_path</span><span class="p">()</span>

    <span class="c1"># Find paths and add to sys.path to be able to import local modules</span>
    <span class="n">test_dir_path</span> <span class="o">=</span> <span class="n">PROJECT_PATHS</span><span class="o">.</span><span class="n">tests</span>

    <span class="k">if</span> <span class="n">test_dir_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">test_dir_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">matplotlib_test_backend</span><span class="p">:</span>
        <span class="n">check_library_is_available</span><span class="p">(</span><span class="s2">&quot;matplotlib&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;agg&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">generate_readme_tests</span><span class="p">:</span>
        <span class="n">add_readme_tests</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">set_numpy_random_seed</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="add_readme_tests"><a class="viewcode-back" href="../../../mypythontools_cicd.tests.html#mypythontools_cicd.tests.add_readme_tests">[docs]</a><span class="k">def</span> <span class="nf">add_readme_tests</span><span class="p">(</span><span class="n">readme_path</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">PathLike</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tests_folder_path</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">PathLike</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate pytest tests script file from README.md and save it to tests folder.</span>

<span class="sd">    Can be called from conftest.</span>

<span class="sd">    Args:</span>
<span class="sd">        readme_path (None | PathLike, optional): If None, autodetected (README.md, Readme.md or readme.md</span>
<span class="sd">            on root). Defaults to None.</span>
<span class="sd">        tests_folder_path (None | PathLike, optional): If None, autodetected (if root / tests).</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If Readme not found.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; add_readme_tests()</span>

<span class="sd">        Readme tests found.</span>

<span class="sd">    Note:</span>
<span class="sd">        Only blocks with python defined syntax will be evaluated. Example::</span>

<span class="sd">            ```python</span>
<span class="sd">            import numpy</span>
<span class="sd">            ```</span>

<span class="sd">        If you want to import modules and use some global variables, add ``&lt;!--phmdoctest-setup--&gt;`` directive</span>
<span class="sd">        before block with setup code.</span>
<span class="sd">        If you want to skip some test, add ``&lt;!--phmdoctest-mark.skip--&gt;``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">readme_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">validate_path</span><span class="p">(</span><span class="n">readme_path</span><span class="p">,</span> <span class="s2">&quot;&#39;add_readme_tests&#39; failed&quot;</span><span class="p">,</span> <span class="s2">&quot;README&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">readme_path</span>
        <span class="k">else</span> <span class="n">PROJECT_PATHS</span><span class="o">.</span><span class="n">readme</span>
    <span class="p">)</span>
    <span class="n">tests_folder_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">validate_path</span><span class="p">(</span><span class="n">tests_folder_path</span><span class="p">,</span> <span class="s2">&quot;&#39;add_readme_tests&#39; failed&quot;</span><span class="p">,</span> <span class="s2">&quot;tests_folder&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tests_folder_path</span>
        <span class="k">else</span> <span class="n">PROJECT_PATHS</span><span class="o">.</span><span class="n">tests</span>
    <span class="p">)</span>

    <span class="n">readme_date_modified</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">readme_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Keep only seconds</span>
    <span class="n">readme_tests_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;test_readme_generated-</span><span class="si">{</span><span class="n">readme_date_modified</span><span class="si">}</span><span class="s2">.py&quot;</span>

    <span class="n">test_file_path</span> <span class="o">=</span> <span class="n">tests_folder_path</span> <span class="o">/</span> <span class="n">readme_tests_name</span>

    <span class="c1"># File not changed from last tests</span>
    <span class="k">if</span> <span class="n">test_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tests_folder_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;test_readme_generated&quot;</span><span class="p">):</span>
            <span class="n">i</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="n">python_path</span> <span class="o">=</span> <span class="n">get_console_str_with_quotes</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
    <span class="n">readme</span> <span class="o">=</span> <span class="n">get_console_str_with_quotes</span><span class="p">(</span><span class="n">readme_path</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">get_console_str_with_quotes</span><span class="p">(</span><span class="n">test_file_path</span><span class="p">)</span>

    <span class="n">generate_readme_test_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">python_path</span><span class="si">}</span><span class="s2"> -m phmdoctest </span><span class="si">{</span><span class="n">readme</span><span class="si">}</span><span class="s2"> --outfile </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">terminal_do_command</span><span class="p">(</span><span class="n">generate_readme_test_command</span><span class="p">,</span> <span class="n">error_header</span><span class="o">=</span><span class="s2">&quot;Readme test creation failed&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="deactivate_test_settings"><a class="viewcode-back" href="../../../mypythontools_cicd.tests.html#mypythontools_cicd.tests.deactivate_test_settings">[docs]</a><span class="k">def</span> <span class="nf">deactivate_test_settings</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Deactivate functionality from setup_tests.</span>

<span class="sd">    Sometimes you want to run test just in normal mode (enable plots etc.). Usually at the end of</span>
<span class="sd">    test file in ``if __name__ = &quot;__main__&quot;:`` block.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mylogging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colorize</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="s2">&quot;matplotlib&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>

        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>

        <span class="n">reload</span><span class="p">(</span><span class="n">matplotlib</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div id="logo">
    <a href="/">
        <img src="_static/logo.png" alt="Logo">
    </a>
</div>

<div class="section" id="table-of-contents">

    <h1>Table of content</h1>

    <ul>
        <li><a href="mypythontools_cicd.build_app.html">build_app</a></li>
        <li><a href="mypythontools_cicd.cicd.html">cicd</a></li>
        <li><a href="mypythontools_cicd.deploy.html">deploy</a></li>
        <li><a href="mypythontools_cicd.docs.html">docs</a></li>
        <li><a href="mypythontools_cicd.git.html">git</a></li>
        <li><a href="mypythontools_cicd.misc.html">misc</a></li>
        <li><a href="mypythontools_cicd.packages.html">packages</a></li>
        <li><a href="mypythontools_cicd.project_paths.html">project_paths</a></li>
        <li><a href="mypythontools_cicd.tests.html">tests</a></li>
        <li><a href="mypythontools_cicd.venvs.html">venvs</a></li>
    </ul>

    <h2><a href="/genindex.html">Index</a></h2>

</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Daniel Malachov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/Malachov/mypythontools_cicd" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>