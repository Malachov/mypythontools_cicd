
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mypythontools_cicd.cicd.cicd_internal &#8212; Python 20-07-2022 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="https://malachov.github.io/mypythontools/tools/sphinx-alabaster-css/custom.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for mypythontools_cicd.cicd.cicd_internal</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module with functions for &#39;cicd&#39; subpackage.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span> <span class="nn">mypythontools.config</span> <span class="kn">import</span> <span class="n">Config</span><span class="p">,</span> <span class="n">MyProperty</span>
<span class="kn">from</span> <span class="nn">mypythontools.misc</span> <span class="kn">import</span> <span class="n">GLOBAL_VARS</span><span class="p">,</span> <span class="n">EMOJIS</span><span class="p">,</span> <span class="n">print_progress</span>
<span class="kn">from</span> <span class="nn">mypythontools.paths</span> <span class="kn">import</span> <span class="n">PathLike</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">git</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">venvs</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">tests</span>
<span class="kn">from</span> <span class="nn">..deploy</span> <span class="kn">import</span> <span class="n">deploy_to_pypi</span>
<span class="kn">from</span> <span class="nn">..docs</span> <span class="kn">import</span> <span class="n">docs_regenerate</span>
<span class="kn">from</span> <span class="nn">..misc</span> <span class="kn">import</span> <span class="n">reformat_with_black</span>
<span class="kn">from</span> <span class="nn">..project_paths</span> <span class="kn">import</span> <span class="n">PROJECT_PATHS</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">packages</span>


<div class="viewcode-block" id="PipelineConfig"><a class="viewcode-back" href="../../../mypythontools_cicd.cicd.html#mypythontools_cicd.cicd.PipelineConfig">[docs]</a><span class="k">class</span> <span class="nc">PipelineConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allow to setup CICD pipeline.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create subconfigs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">:</span> <span class="n">tests</span><span class="o">.</span><span class="n">TestConfig</span> <span class="o">=</span> <span class="n">tests</span><span class="o">.</span><span class="n">default_test_config</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">do_only</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;prepare_venvs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reformat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sync_test_requirements&quot;</span><span class="p">,</span>
        <span class="s2">&quot;git_commit_all&quot;</span><span class="p">,</span>
        <span class="s2">&quot;git_push&quot;</span><span class="p">,</span>
        <span class="s2">&quot;deploy&quot;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run just single function from pipeline, ignore the others.</span>

<span class="sd">        Type:</span>
<span class="sd">            Literal[</span>
<span class="sd">                None, &quot;prepare_venvs&quot;, &quot;reformat&quot;, &quot;test&quot;, &quot;docs&quot;, &quot;sync_test_requirements&quot;, &quot;git_commit_all&quot;,</span>
<span class="sd">                &quot;git_push&quot;, &quot;deploy&quot;</span>
<span class="sd">            ]</span>

<span class="sd">        Default:</span>
<span class="sd">            None</span>

<span class="sd">        Reason for why to call it form here and not directly is to be able to use sys args or single command</span>
<span class="sd">        line entrypoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prepare_venvs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create venvs with defined versions.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | list[str]</span>

<span class="sd">        Default:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prepare_venvs_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PathLike</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Prepare venvs in defined path.</span>

<span class="sd">        Type:</span>
<span class="sd">            str</span>

<span class="sd">        Default:</span>
<span class="sd">            &quot;venv&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;venv&quot;</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">reformat</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reformat all python files with black. Setup parameters in pyproject.toml.</span>

<span class="sd">        Type:</span>
<span class="sd">            bool</span>

<span class="sd">        Default:</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Overwrite __version__ in __init__.py.</span>

<span class="sd">        Type:</span>
<span class="sd">            str</span>

<span class="sd">        Default:</span>
<span class="sd">            &#39;increment&#39;.</span>

<span class="sd">        Version has to be in format like &#39;1.0.3&#39; three digits and two dots. If &#39;None&#39;, nothing will happen. If</span>
<span class="sd">        &#39;increment&#39;, than it will be updated by 0.0.1..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;increment&quot;</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">docs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define whether generate sphinx apidoc and generate rst files for documentation.</span>

<span class="sd">        Type:</span>
<span class="sd">            bool</span>

<span class="sd">        Default:</span>
<span class="sd">            True</span>

<span class="sd">        Some files in docs source can be deleted - check `docs` docstrings for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sync_requirements</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;infer&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">PathLike</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PathLike</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check requirements.txt and update all the libraries.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | Literal[&quot;infer&quot;] | PathLike | Sequence[PathLike]</span>

<span class="sd">        Default:</span>
<span class="sd">            None</span>

<span class="sd">        You can use path to requirements, list of paths. If &quot;infer&quot;, auto detected (all requirements), not</span>
<span class="sd">        recursively, only on defined path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sync_requirements_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PathLike</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define the root if using just names or relative path, and not found.</span>

<span class="sd">        Type:</span>
<span class="sd">            PathLike</span>

<span class="sd">        Default:</span>
<span class="sd">            PROJECT_PATHS.root</span>

<span class="sd">        It&#39;s also necessary when using another referenced files. If inferring files, it&#39;s used to search.</span>
<span class="sd">        Defaults to PROJECT_PATHS.root.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PROJECT_PATHS</span><span class="o">.</span><span class="n">root</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">git_commit_all</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether take all the changes in repository and create a commit with these changes.</span>

<span class="sd">        Note:</span>
<span class="sd">            !!! Be cautious here if using with `git_push` !!!</span>

<span class="sd">        Type:</span>
<span class="sd">            None | str</span>

<span class="sd">        Default:</span>
<span class="sd">            &#39;New commit&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;New commit&quot;</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">git_push</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether push to repository.</span>

<span class="sd">        Type:</span>
<span class="sd">            bool</span>

<span class="sd">        Default:</span>
<span class="sd">            True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">tag</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tag. E.g &#39;v1.1.2&#39;. If &#39;__version__&#39;, get the version.</span>

<span class="sd">        Type:</span>
<span class="sd">            str | None</span>

<span class="sd">        Default:</span>
<span class="sd">            &#39;__version__&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;__version__&quot;</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">tag_message</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tag message.</span>

<span class="sd">        Type:</span>
<span class="sd">            str</span>

<span class="sd">        Default:</span>
<span class="sd">            &#39;New version&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;New version&quot;</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deploy</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Deploy to PYPI.</span>

<span class="sd">        `TWINE_USERNAME` and `TWINE_PASSWORD` are used for authorization.</span>

<span class="sd">        Type:</span>
<span class="sd">            bool</span>

<span class="sd">        Default:</span>
<span class="sd">            False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">allowed_branches</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Pipeline runs only on defined branches.</span>

<span class="sd">        Type:</span>
<span class="sd">            None | Sequence[str]</span>

<span class="sd">        Default:</span>
<span class="sd">            [&quot;master&quot;, &quot;main&quot;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;master&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">]</span>

    <span class="nd">@MyProperty</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">verbosity</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Pipeline runs only on defined branches.</span>

<span class="sd">        Type:</span>
<span class="sd">            Literal[0, 1, 2]</span>

<span class="sd">        Default:</span>
<span class="sd">            1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">1</span></div>


<span class="n">default_pipeline_config</span> <span class="o">=</span> <span class="n">PipelineConfig</span><span class="p">()</span>


<div class="viewcode-block" id="cicd_pipeline"><a class="viewcode-back" href="../../../mypythontools_cicd.cicd.html#mypythontools_cicd.cicd.cicd_pipeline">[docs]</a><span class="k">def</span> <span class="nf">cicd_pipeline</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">PipelineConfig</span> <span class="o">=</span> <span class="n">default_pipeline_config</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Run pipeline for pushing and deploying an app or a package.</span>

<span class="sd">    Can run tests, generate rst files for sphinx docs, push to github and deploy to pypi. All params can be</span>
<span class="sd">    configured not only with function params, but also from command line with params and therefore callable</span>
<span class="sd">    from terminal and optimal to run from IDE (for example with creating simple VS Code task).</span>

<span class="sd">    Some function suppose some project structure (where are the docs, where is `__init__.py` etc.).</span>
<span class="sd">    If you are issuing some error, try functions directly, find necessary paths in parameters</span>
<span class="sd">    and set paths that are necessary in paths module.</span>

<span class="sd">    Note:</span>
<span class="sd">        Beware, that by default, it creates a commit and add all the changes, not only the staged ones.</span>

<span class="sd">    When using sys args for boolean values, always define True or False.</span>

<span class="sd">    There is command line entrypoint called `mypythontools_cicd`. After mypythontools is installed, you can</span>
<span class="sd">    use it in terminal like::</span>

<span class="sd">        mypythontools_cicd --do_only reformat</span>

<span class="sd">    Args:</span>
<span class="sd">        config (PipelineConfig, optional): PipelineConfig object with CICD pipeline configuration. Just import</span>
<span class="sd">            default_pipeline_config and use intellisense and help tooltip with description. It is also</span>
<span class="sd">            possible to configure all the params with CLI args from terminal.</span>
<span class="sd">            Defaults to `default_pipeline_config`.</span>

<span class="sd">    Example:</span>
<span class="sd">        Recommended use is from IDE (for example with Tasks in VS Code). Check utils docs for how to use it.</span>
<span class="sd">        You can also use it from python... ::</span>

<span class="sd">            from mypythontools_cicd.cicd import cicd_pipeline, default_pipeline_config</span>

<span class="sd">            default_pipeline_config.deploy = True</span>
<span class="sd">            # default_pipeline_config.do_only = &quot;&quot;</span>


<span class="sd">            if __name__ == &quot;__main__&quot;:</span>
<span class="sd">                # All the parameters can be overwritten via CLI args</span>
<span class="sd">                cicd_pipeline(config=default_pipeline_config)</span>

<span class="sd">        It&#39;s also possible to use CLI and configure it via args. This example just push repo to PyPi. ::</span>

<span class="sd">            python path-to-project/utils/push_script.py --do_only deploy</span>

<span class="sd">    Another way how to run it is to use IDE. For example in VS Code you can use Tasks. Check `cicd`</span>
<span class="sd">    docs for examples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">GLOBAL_VARS</span><span class="o">.</span><span class="n">is_tested</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">with_argparse</span><span class="p">()</span>

    <span class="n">do_only</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">do_only</span>

    <span class="c1"># If do_only change subconfig value and not config, change it</span>
    <span class="k">if</span> <span class="n">do_only</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
        <span class="n">do_only</span> <span class="o">=</span> <span class="s2">&quot;run_tests&quot;</span>

    <span class="k">if</span> <span class="n">do_only</span><span class="p">:</span>
        <span class="n">do_only_value</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">do_only</span><span class="p">]</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;prepare_venvs&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;reformat&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;run_tests&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;sync_requirements&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;git_commit_all&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;git_push&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;deploy&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">do_only</span><span class="p">:</span> <span class="n">do_only_value</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">verbosity</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">verbosity</span>
    <span class="n">progress_is_printed</span> <span class="o">=</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">allowed_branches</span><span class="p">:</span>
        <span class="n">git</span><span class="o">.</span><span class="n">check_branch</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">allowed_branches</span><span class="p">)</span>

    <span class="c1"># Do some checks before run pipeline so not need to rollback eventually</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">deploy</span><span class="p">:</span>
        <span class="n">usr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TWINE_USERNAME&quot;</span><span class="p">)</span>
        <span class="n">pas</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TWINE_PASSWORD&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">usr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pas</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Setup env vars TWINE_USERNAME and TWINE_PASSWORD to use deploy.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;__version__&quot;</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">version</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;increment&quot;</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">packages</span><span class="o">.</span><span class="n">increment_version</span><span class="p">(</span><span class="n">packages</span><span class="o">.</span><span class="n">get_version</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">packages</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tag</span>
        <span class="n">git</span><span class="o">.</span><span class="n">check_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">prepare_venvs</span><span class="p">:</span>
        <span class="n">venvs</span><span class="o">.</span><span class="n">prepare_venvs</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">prepare_venvs_path</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">prepare_venvs</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sync_requirements</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">venvs</span><span class="o">.</span><span class="n">is_venv</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;&#39;sync_requirements&#39; available only if using virtualenv.&quot;</span><span class="p">)</span>
        <span class="n">my_venv</span> <span class="o">=</span> <span class="n">venvs</span><span class="o">.</span><span class="n">Venv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">my_venv</span><span class="o">.</span><span class="n">sync_requirements</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">sync_requirements</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sync_requirements_path</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
        <span class="n">tests</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">reformat</span><span class="p">:</span>
        <span class="n">reformat_with_black</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">version</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">print_progress</span><span class="p">(</span><span class="s2">&quot;Setting version&quot;</span><span class="p">,</span> <span class="n">progress_is_printed</span><span class="p">)</span>
        <span class="n">original_version</span> <span class="o">=</span> <span class="n">packages</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>
        <span class="n">packages</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">docs</span><span class="p">:</span>
        <span class="n">docs_regenerate</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">git_commit_all</span><span class="p">:</span>
        <span class="n">git</span><span class="o">.</span><span class="n">commit_all</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">git_commit_all</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">git_push</span><span class="p">:</span>
            <span class="n">git</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                <span class="n">tag</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">tag_message</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">tag_message</span><span class="p">,</span>
                <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
            <span class="n">packages</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">original_version</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">3</span> <span class="o">*</span> <span class="n">EMOJIS</span><span class="o">.</span><span class="n">DISAPPOINTMENT</span><span class="si">}</span><span class="s2"> Utils pipeline failed </span><span class="si">{</span><span class="mi">3</span> <span class="o">*</span> <span class="n">EMOJIS</span><span class="o">.</span><span class="n">DISAPPOINTMENT</span><span class="si">}</span><span class="s2"> </span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Original version restored. &#39;</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">version</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">Nothing was pushed to repo, &quot;</span>
            <span class="s2">&quot;you can restart pipeline. Commit already created.&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">deploy</span><span class="p">:</span>
            <span class="n">deploy_to_pypi</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">3</span> <span class="o">*</span> <span class="n">EMOJIS</span><span class="o">.</span><span class="n">DISAPPOINTMENT</span><span class="si">}</span><span class="s2"> Deploy failed </span><span class="si">{</span><span class="mi">3</span> <span class="o">*</span> <span class="n">EMOJIS</span><span class="o">.</span><span class="n">DISAPPOINTMENT</span><span class="si">}</span><span class="s2"> </span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Already pushed to repository. Deploy manually. Version already changed.&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

    <span class="n">print_progress</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">3</span> <span class="o">*</span> <span class="n">EMOJIS</span><span class="o">.</span><span class="n">PARTY</span><span class="si">}</span><span class="s2"> Finished </span><span class="si">{</span><span class="mi">3</span> <span class="o">*</span> <span class="n">EMOJIS</span><span class="o">.</span><span class="n">PARTY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div id="logo">
    <a href="/">
        <img src="_static/logo.png" alt="Logo">
    </a>
</div>

<div class="section" id="table-of-contents">

    <h1>Table of content</h1>

    <ul>
        <li><a href="mypythontools_cicd.build_app.html">build_app</a></li>
        <li><a href="mypythontools_cicd.cicd.html">cicd</a></li>
        <li><a href="mypythontools_cicd.deploy.html">deploy</a></li>
        <li><a href="mypythontools_cicd.docs.html">docs</a></li>
        <li><a href="mypythontools_cicd.git.html">git</a></li>
        <li><a href="mypythontools_cicd.misc.html">misc</a></li>
        <li><a href="mypythontools_cicd.packages.html">packages</a></li>
        <li><a href="mypythontools_cicd.project_paths.html">project_paths</a></li>
        <li><a href="mypythontools_cicd.tests.html">tests</a></li>
        <li><a href="mypythontools_cicd.venvs.html">venvs</a></li>
    </ul>

    <h2><a href="/genindex.html">Index</a></h2>

</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Daniel Malachov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/Malachov/mypythontools_cicd" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>